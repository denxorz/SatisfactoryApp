@page "/"
@using SatisfactoryApp.Components
@using MudBlazor
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager NavigationManager

<MudTabs Style="background-color: #303030 !important; background-image: none !important; opacity: 1 !important;"
         ActivePanelIndex="_activeTabIndex"
         ApplyEffectsToContainer="true" 
         PanelClass="pa-1"
         Elevation="2"
         ActivePanelIndexChanged="OnTabChanged">
    <MudTabPanel Text="Stations & Logistics" Icon="@Icons.Material.Filled.Train">
        <MudGrid>
            <MudItem xs="12">
                <StationFilters />
            </MudItem>
            <MudItem xs="12">
                <CargoFlowChart />
            </MudItem>
            <MudItem xs="12" lg="6">
                <StationGraph />
            </MudItem>
            <MudItem xs="12" lg="6">
                <StationsTable />
            </MudItem>
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Factory Maps" Icon="@Icons.Material.Filled.Factory">
        <FactoryFilters />
        <MudGrid Class="mt-4">
            <MudItem xs="12" lg="6">
                <FactoryStabilityMap />
            </MudItem>
            <MudItem xs="12" lg="6">
                <FactoryPowerCircuitMap />
            </MudItem>
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Route Calculator" Icon="@Icons.Material.Filled.Calculate">
        <RouteCalculatorAOT />
    </MudTabPanel>
</MudTabs>

@code {
    private int _activeTabIndex = 0;

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("tab", out var tab) && int.TryParse(tab, out var tabIndex))
        {
            _activeTabIndex = tabIndex is >= 0 and <= 2 ? tabIndex : 0;
        }
    }

    private Task OnTabChanged(int newIndex)
    {
        _activeTabIndex = newIndex is >= 0 and <= 2 ? newIndex : 0;

        var targetUri = NavigationManager.GetUriWithQueryParameter("tab", _activeTabIndex);
        NavigationManager.NavigateTo(targetUri, replace: true);

        return Task.CompletedTask;
    }
}
