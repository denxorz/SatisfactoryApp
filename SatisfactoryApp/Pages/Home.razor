@page "/"
@using SatisfactoryApp.Components
@using MudBlazor
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager NavigationManager

<MudTabs ActivePanelIndex="_activeTabIndex"
         ApplyEffectsToContainer="true"          
         Elevation="2"
         ActivePanelIndexChanged="OnTabChanged">
    <MudTabPanel Text="Factory Maps" Icon="@Icons.Material.Filled.Factory" Class="pt-1">
          <MudGrid Spacing="3">
            <MudItem xs="12">
                <FactoryFilters />
            </MudItem>
            <MudItem xs="12" lg="6">
                <FactoryStabilityMap />
            </MudItem>
            <MudItem xs="12" lg="6">
                <FactoryPowerCircuitMap />
            </MudItem>
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Stations & Logistics" Icon="@Icons.Material.Filled.Train" Class="pt-1">
        <MudGrid Spacing="3">
            <MudItem xs="12">
                <StationFilters />
            </MudItem>
            <MudItem xs="12">
                <CargoFlowChart />
            </MudItem>
            <MudItem xs="12" lg="6">
                <StationGraph />
            </MudItem>
            <MudItem xs="12" lg="6">
                <StationsTable />
            </MudItem>
        </MudGrid>
    </MudTabPanel>
</MudTabs>

@code {
    private int _activeTabIndex = 0;

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("tab", out var tab) && int.TryParse(tab, out var tabIndex))
        {
            _activeTabIndex = tabIndex is >= 0 and <= 1 ? tabIndex : 0;
        }
    }

    private Task OnTabChanged(int newIndex)
    {
        _activeTabIndex = newIndex is >= 0 and <= 1 ? newIndex : 0;

        var targetUri = NavigationManager.GetUriWithQueryParameter("tab", _activeTabIndex);
        NavigationManager.NavigateTo(targetUri, replace: true);

        return Task.CompletedTask;
    }
}
