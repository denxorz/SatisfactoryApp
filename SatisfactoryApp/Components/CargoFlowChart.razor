@using SatisfactoryApp.Models
@using SatisfactoryApp.Services
@using MudBlazor
@inject StationStore StationStore

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h6">Cargo Flow</MudText>
    </MudCardHeader>
    <MudCardContent>
        @{
            var flowData = new Dictionary<string, (double consumed, double produced, double delta)>();
            
            foreach (var station in StationStore.FilteredStations)
            {
                if (station.CargoFlows == null) continue;
                
                foreach (var flow in station.CargoFlows)
                {
                    if (flow == null || string.IsNullOrEmpty(flow.Type) || !flow.FlowPerMinute.HasValue) continue;
                    
                    var type = flow.Type;
                    if (!flowData.ContainsKey(type))
                    {
                        flowData[type] = (0, 0, 0);
                    }
                    
                    var current = flowData[type];
                    if (flow.IsUnload)
                    {
                        flowData[type] = (current.consumed + flow.FlowPerMinute.Value, current.produced, current.delta - flow.FlowPerMinute.Value);
                    }
                    else
                    {
                        flowData[type] = (current.consumed, current.produced + flow.FlowPerMinute.Value, current.delta + flow.FlowPerMinute.Value);
                    }
                }
            }
            
            var sortedFlowData = flowData.OrderBy(kvp => kvp.Key).ToList();
        }
        
        @if (sortedFlowData.Count > 0)
        {
            <MudTable Items="@sortedFlowData" Hover="true" Dense="true" Striped="true">
                <HeaderContent>
                    <MudTh>Cargo Type</MudTh>
                    <MudTh align="right">Produced</MudTh>
                    <MudTh align="right">Consumed</MudTh>
                    <MudTh align="right">Available</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudText>@context.Key</MudText>
                    </MudTd>
                    <MudTd align="right">
                        <MudText Color="Color.Success">@context.Value.produced.ToString("F0")</MudText>
                    </MudTd>
                    <MudTd align="right">
                        <MudText Color="Color.Warning">@context.Value.consumed.ToString("F0")</MudText>
                    </MudTd>
                    <MudTd align="right">
                        <MudText Color="@(context.Value.delta >= 0 ? Color.Success : Color.Error)">
                            @context.Value.delta.ToString("F0")
                        </MudText>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Info">No Cargo Flow Data Available</MudAlert>
        }
    </MudCardContent>
</MudCard>

