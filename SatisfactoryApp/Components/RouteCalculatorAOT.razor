@using SatisfactoryApp.Services
@using Denxorz.Satisfactory.Routes
@using MudBlazor
@inject RouteCalculationService RouteCalculationService
@inject FactoryStore FactoryStore
@inject StationStore StationStore

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h6">Route Calculator (Optimized Blazor WebAssembly)</MudText>
    </MudCardHeader>
    <MudCardContent>

        <MudStack Row="true" Spacing="2" Class="mb-4">
            <InputFile OnChange="HandleFileSelect" accept=".sav" class="d-none" id="fileInput" />
            <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Upload" for="fileInput" Disabled="@_isCalculating">
                @(_isCalculating ? "Processing..." : "Upload Save File")
            </MudButton>
            @if (_selectedFile != null)
            {
                <MudText>@_selectedFile.Name</MudText>
            }
        </MudStack>

        @if (!string.IsNullOrEmpty(_error))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                <MudText Typo="Typo.h6">Error:</MudText>
                <MudText>@_error</MudText>
            </MudAlert>
        }

        <MudCard Class="mt-4">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-4">Calculation Result:</MudText>
                <MudStack Row="true" Spacing="4">
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">Stations: @(StationStore.Stations.Count)</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">Uploaders: @(StationStore.Uploaders.Count)</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">Factories: @(FactoryStore.Factories.Count)</MudChip>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudCardContent>
</MudCard>

@code {
    private IBrowserFile? _selectedFile;
    private bool _isCalculating;
    private string? _error;

    private async Task HandleFileSelect(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _error = null;

        await CalculateRoutes();
    }

    private async Task CalculateRoutes()
    {
        if (_selectedFile == null) return;

        _isCalculating = true;
        _error = null;

        try
        {
            using var stream = _selectedFile.OpenReadStream(maxAllowedSize: 100_000_000);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var bytes = memoryStream.ToArray();

            Console.WriteLine("Loaded...");

            var result = await RouteCalculationService.CalculateRoutesAsync(bytes);
            FactoryStore.SetFactories(result.Factories);
 

            // StationStore.SetStations(result.Stations);
            // StationStore.SetUploaders(result.Uploaders);

            Console.WriteLine("Parsed...");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            _error = ex.Message;
        }
        finally
        {
            _isCalculating = false;
        }
    }
}

