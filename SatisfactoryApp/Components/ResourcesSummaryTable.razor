@using Denxorz.Satisfactory.Routes.Types
@using SatisfactoryApp.Services
@using MudBlazor
@inject ResourceStore ResourceStore

<MudCard Outlined="true" Square="true" Class="border-solid border-4 mud-border-primary">
    <MudCardHeader Class="mud-primary pa-0 pl-1">
        <MudText Class="primary-card-header-title" Color="Color.Surface">Resources Summary</MudText>
    </MudCardHeader>
    <MudCardContent Class="pa-2">
        <MudTable Items="@_resourceTypeStats" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Type</MudTh>
                <MudTh align="right">Total Leftover</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Type">
                    <MudText>@context.Type</MudText>
                </MudTd>
                <MudTd DataLabel="Total Leftover" align="right">@context.TotalLeft.ToString("N0")</MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private List<ResourceTypeStat> _resourceTypeStats = [];

    protected override void OnInitialized()
    {
        ResourceStore.ResourcesChanged += UpdateResourceTypeStats;
        UpdateResourceTypeStats();
    }

    private void UpdateResourceTypeStats()
    {
        var stats = ResourceStore.Resources
            .GroupBy(r => r.Type ?? "Unknown")
            .Select(g => new ResourceTypeStat
            {
                Type = g.Key,
                TotalLeft = g.Sum(r => r.Max - r.Flow)
            })
            .OrderBy(s => s.Type)
            .ToList();

        _resourceTypeStats = stats;
        StateHasChanged();
    }

    private class ResourceTypeStat
    {
        public string Type { get; set; } = string.Empty;
        public float TotalLeft { get; set; }
    }
}
