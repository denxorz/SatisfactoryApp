@using SatisfactoryApp.Services
@using MudBlazor
@inject StationStore StationStore

<MudCard Outlined="true" Square="true" Class="border-solid border-4 mud-border-primary">
    <MudCardHeader Class="mud-primary pa-0 pl-1">
        <MudText Class="primary-card-header-title">Station Filters</MudText>
    </MudCardHeader>
    <MudCardContent Class="pa-2">
        <MudGrid Spacing="1">
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_searchText" 
                              Label="Search Stations" 
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudComboBox T="CargoTypeOption"
                             @bind-SelectedValues="@StationStore.SelectedCargoTypes"
                             Variant="Variant.Outlined"
                             MultiSelection
                             Label="Cargo"
                             Editable
                             Clearable
                             SelectAll
                             ShowCheckbox>
                    @foreach (var item in StationStore.CargoTypeOptions)
                    {
                        <MudComboBoxItem Value="@item" Text="@item.ToString()"></MudComboBoxItem>
                    }
                </MudComboBox>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudChipSet @bind-SelectedValues="StationStore.SelectedTransferTypes"
                            SelectionMode="SelectionMode.MultiSelection" 
                            Color="Color.Primary">
                    <MudChip Value="@("Load")" Icon="@Icons.Material.Filled.Input" />
                    <MudChip Value="@("Unload")" Icon="@Icons.Material.Filled.Output" />
                    <MudChip Value="@("Uploader")" Icon="@Icons.Material.Filled.CloudUpload" />
                </MudChipSet>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudChipSet @bind-SelectedValues="StationStore.SelectedStationTypes"
                            SelectionMode="SelectionMode.MultiSelection"
                            Color="Color.Primary">
                    <MudChip Value="@("Train")" Icon="@Icons.Material.Filled.Train" />
                    <MudChip Value="@("Truck")" Icon="@Icons.Material.Filled.LocalShipping" />
                    <MudChip Value="@("Drone")" Icon="@Icons.Material.Filled.Flight" />
                </MudChipSet>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

@code {
    private int _lastUpdateCounter = -1;
    private Services.StationFilters _filters => StationStore.Filters;

    private readonly List<CargoTypeOption> CargoTypeOptions = [];

    protected override void OnInitialized()
    {
        CargoTypeOptions.AddRange(StationStore.CargoTypeOptions);
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _lastUpdateCounter = StationStore.UpdateCounter;
        }
        
        if (StationStore.UpdateCounter != _lastUpdateCounter)
        {
            _lastUpdateCounter = StationStore.UpdateCounter;
            StateHasChanged();
        }
    }

    private string _searchText
    {
        get => _filters.SearchText;
        set
        {
            _filters.SearchText = value;
            StationStore.NotifyFiltersChanged();
            StateHasChanged();
        }
    }
}

