@using Denxorz.Satisfactory.Routes.Types
@using MudBlazor
@using SatisfactoryApp.Services
@using SatisfactoryApp.Services.Factories
@using SatisfactoryApp.Utils
@inject FactoryStore FactoryStore
@implements IDisposable

<MudCard Outlined="true" Square="true" Class="border-solid border-4 mud-border-primary">
    <MudCardHeader Class="mud-primary pa-0 pl-1">
        <MudText Class="primary-card-header-title" Color="Color.Surface">Power Circuits</MudText>
    </MudCardHeader>
    <MudCardContent Class="pa-2">
        <MudDataGrid @ref="_dataGrid" Items="@_powerSubCircuitStats" Hover Dense Groupable GroupExpanded>
            <Columns>
                <PropertyColumn Property="@(x => x.ParentCircuitId)" Title="Group" Grouping Sortable="false" Hidden />
                <PropertyColumn Property="@(x => x.IsStable)" Title="" Groupable="false">
                    <CellTemplate>
                        <MudTooltip Text="@($"Power usage is stable: {(context.Item.IsStable ? "Yes" : "No")}")">
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.CheckCircle)" Color="Color.Success" Disabled="!context.Item.IsStable" Size="Size.Small" Class=@($"ml-4 mr-1 {(!context.Item.IsStable ? "disabled-faded-icon" : "")}") />
                        </MudTooltip>
                        <MudTooltip Text="@($"{context.Item.NumberOfNotStable} not running at 100%")">
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Warning)" Color="Color.Primary" Disabled="context.Item.NumberOfNotStable == 0" Size="Size.Small" Class=@($"mr-1 {(context.Item.NumberOfNotStable == 0 ? "disabled-faded-icon" : "")}") />
                        </MudTooltip>
                        <MudTooltip Text="@($"{context.Item.NumberOfVariablePower} have variable power usage")">
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.ShowChart)" Color="Color.Primary" Disabled="context.Item.NumberOfVariablePower == 0" Size="Size.Small" Class=@($"mr-1 {(context.Item.NumberOfVariablePower == 0 ? "disabled-faded-icon" : "")}") />
                        </MudTooltip>
                        <MudTooltip Text="@($"{context.Item.NumberOfPowerStorage} power storages")">
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Battery6Bar)" Color="Color.Info" Disabled="context.Item.NumberOfPowerStorage == 0" Size="Size.Small" Class=@($"mr-1 {(context.Item.NumberOfPowerStorage == 0 ? "disabled-faded-icon" : "")}") />
                        </MudTooltip>
                        <MudTooltip Text="@($"{context.Item.NumberOfPowerGenerator} generators")">
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.EvStation)" Color="Color.Info" Disabled="context.Item.NumberOfPowerGenerator == 0" Size="Size.Small" Class=@($"mr-1 {(context.Item.NumberOfPowerGenerator == 0 ? "disabled-faded-icon" : "")}") />
                        </MudTooltip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="@(x => x.CircuitName)" Title="Name" Groupable="false">
                    <CellTemplate>
                        <MudText Color="@(context.Item.IsStable? Color.Default: Color.Primary)">@context.Item.CircuitName</MudText>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="@(x => x.Total)" Title="Total" align="right" Groupable="false" />
                <PropertyColumn Property="@(x => x.NumberOfNotStable)" Title="Not running at 100%" align="right" Groupable="false">
                    <CellTemplate>
                        <MudText Color="@(context.Item.NumberOfNotStable != 0 ? Color.Primary : Color.Default)">(@context.Item.NumberOfNotStable / @context.Item.Total)</MudText>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="@(x => x.NumberOfVariablePower)" Title="Variable power" align="right" Groupable="false">
                    <CellTemplate>
                        <MudText Color="@(context.Item.NumberOfVariablePower > 0 ? Color.Primary : Color.Default)">(@context.Item.NumberOfVariablePower / @context.Item.Total)</MudText>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="@(x => x.Priority)" Title="Priority" align="right" Groupable="false" />
            </Columns>
            <GroupTemplate>
                <span style="font-weight:bold">
                    @if (context.DataGrid.FilteredItems.Any())
                    {
                        var mainCircuit = _powerMainCircuitStats[context.Grouping.First().ParentCircuitId ?? 0];

                        <div class="d-flex align-center">
                            <MudTooltip Text="@($"Power usage is stable: {(mainCircuit.IsStable ? "Yes" : "No")}")">
                                <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.CheckCircle)" Color="Color.Success" Disabled="!mainCircuit.IsStable" Size="Size.Small" Class=@($"mr-1 {(!mainCircuit.IsStable ? "disabled-faded-icon" : "")}") />
                            </MudTooltip>
                            <MudTooltip Text="@($"{mainCircuit.NumberOfNotStable} not running at 100%")">
                                <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Warning)" Color="Color.Primary" Disabled="mainCircuit.NumberOfNotStable == 0" Size="Size.Small" Class=@($"mr-1 {(mainCircuit.NumberOfNotStable == 0 ? "disabled-faded-icon" : "")}") />
                            </MudTooltip>
                            <MudTooltip Text="@($"{mainCircuit.NumberOfVariablePower} have variable power usage")">
                                <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.ShowChart)" Color="Color.Primary" Disabled="mainCircuit.NumberOfVariablePower == 0" Size="Size.Small" Class=@($"mr-1 {(mainCircuit.NumberOfVariablePower == 0 ? "disabled-faded-icon" : "")}") />
                            </MudTooltip>
                            <MudTooltip Text="@($"{mainCircuit.NumberOfPowerStorage} power storages")">
                                <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Battery6Bar)" Color="Color.Info" Disabled="mainCircuit.NumberOfPowerStorage == 0" Size="Size.Small" Class=@($"mr-1 {(mainCircuit.NumberOfPowerStorage == 0 ? "disabled-faded-icon" : "")}") />
                            </MudTooltip>
                            <MudTooltip Text="@($"{mainCircuit.NumberOfPowerGenerator} generators")">
                                <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.EvStation)" Color="Color.Info" Disabled="mainCircuit.NumberOfPowerGenerator == 0" Size="Size.Small" Class=@($"mr-1 {(mainCircuit.NumberOfPowerGenerator == 0 ? "disabled-faded-icon" : "")}") />
                            </MudTooltip>
                            <span class="ml-6">[@mainCircuit.CircuitId]</span>
                            <span class="ml-6">Total: @mainCircuit.Total</span>
                            <span class="ml-6">Not running at 100%: @mainCircuit.NumberOfNotStable</span>
                            <span class="ml-6">Variable power: @mainCircuit.NumberOfVariablePower</span>
                        </div>
                    }
                    else
                    {
                        <span style="font-weight:bold">??</span>
                    }
                </span>
            </GroupTemplate>
        </MudDataGrid>
    </MudCardContent>
</MudCard>

<style>
    .disabled-faded-icon {
        color: var(--mud-palette-background-grey, #2b2b2b) !important;
        fill: var(--mud-palette-background-grey, #2b2b2b) !important;
        opacity: 0.90 !important;
    }
</style>

@code {
    private MudDataGrid<PowerCircuitStat>? _dataGrid;
    private List<PowerCircuitStat> _powerSubCircuitStats = [];
    private Dictionary<int, PowerCircuitStat> _powerMainCircuitStats = [];
    private int _groupRenderIndex = 0;

    protected override void OnInitialized()
    {
        FactoryStore.FactoriesChanged += UpdateStats;
        UpdateStats();
    }

    public void Dispose()
    {
        FactoryStore.FactoriesChanged -= UpdateStats;
    }

    private void UpdateStats()
    {
        var statsMain = new Dictionary<int, PowerCircuitStat>();
        var statsSub = new Dictionary<int, PowerCircuitStat>();

        foreach (var c in FactoryStore.PowerCircuits)
        {
            bool isMainCircuit = c.ParentCircuitId is null;
            var factories = FactoryStore.Factories
                .Where(f => isMainCircuit ? f.MainPowerCircuitId == c.Id : f.SubPowerCircuitId == c.Id)
                .ToList();

            var notStable = factories.Count(f => f.PercentageProducing is not null && f.PercentageProducing != 100);
            var variablePower = factories.Count(IsVariablePowerFactory);
            var powerstorage = factories.Count(IsPowerStorage);
            var powerProducers = factories.Count(IsPowerProducerStorage);

            if (isMainCircuit)
            {
                statsMain[c.Id] = new PowerCircuitStat
                {
                    CircuitId = c.Id,
                    CircuitName = CircuitNames.GetName(c),
                    Total = factories.Count,
                    NumberOfNotStable = notStable,
                    NumberOfVariablePower = variablePower,
                    NumberOfPowerStorage = powerstorage,
                    NumberOfPowerGenerator = powerProducers,
                    Priority = c.Priority,
                    IsStable = notStable == 0 && variablePower == 0
                };
            }
            else
            {
                statsSub[c.Id] = new PowerCircuitStat
                {
                    CircuitId = c.Id,
                    CircuitName = CircuitNames.GetName(c),
                    ParentCircuitId = c.ParentCircuitId,
                    Total = factories.Count,
                    NumberOfNotStable = notStable,
                    NumberOfVariablePower = variablePower,
                    NumberOfPowerStorage = powerstorage,
                    NumberOfPowerGenerator = powerProducers,
                    Priority = c.Priority,
                    IsStable = notStable == 0 && variablePower == 0
                };
            }
        }

        _powerMainCircuitStats = statsMain.Values
            .OrderBy(s => s.CircuitId)
            .ToDictionary(s => s.CircuitId, s => s);

        _powerSubCircuitStats = statsSub.Values
            .OrderBy(s => s.CircuitId)
            .ToList();

        _groupRenderIndex = 0;
        StateHasChanged();
    }

    private static bool IsVariablePowerFactory(Factory factory)
    {
        var types = new[] { "Converter", "HadronCollider", "QuantumEncoder", "TrainStation", "ResourceSink", "GeneratorGeoThermal" };
        return factory.Type != null && types.Contains(factory.Type);
    }

    private static bool IsPowerStorage(Factory factory)
    {
        return factory.Type == "PowerStorage";
    }

    private static bool IsPowerProducerStorage(Factory factory)
    {
        return factory.Type != null && factory.Type.StartsWith("Generator");
    }

    private string GetMainCircuitNameFromParentId(string? parentId)
    {
        if (!string.IsNullOrEmpty(parentId) && int.TryParse(parentId, out var parentIdInt) && _powerMainCircuitStats.ContainsKey(parentIdInt))
        {
            return _powerMainCircuitStats[parentIdInt].CircuitName;
        }
        return parentId ?? "Unknown";
    }

    private class PowerCircuitStat
    {
        public int CircuitId { get; set; }
        public string CircuitName { get; set; } = string.Empty;
        public int Total { get; set; }
        public int NumberOfNotStable { get; set; }
        public int NumberOfVariablePower { get; set; }
        public int NumberOfPowerStorage { get; set; }
        public int NumberOfPowerGenerator { get; set; }
        public int? Priority { get; set; }
        public bool IsStable { get; set; }
        public int? ParentCircuitId { get; set; }
    }
}

