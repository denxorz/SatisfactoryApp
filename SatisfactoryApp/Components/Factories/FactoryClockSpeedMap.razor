@using Denxorz.Satisfactory.Routes.Types
@using Microsoft.JSInterop
@using MudBlazor
@using SatisfactoryApp.Services
@using SatisfactoryApp.Services.Factories
@using SatisfactoryApp.Utils
@inject FactoryStore FactoryStore

<BaseMap @ref="Map"
                 Title="Factory Clock speed"
                 CreateEdge="CreateEdge"
                 SelectedChanged="SelectedChanged"
                 CustomRender="CustomRender"
                 CustomFactoriesForMapClick="CustomFactoriesForMapClick"
                 ExtraFactoryFilter="(f) => f.ClockSpeed.HasValue"
                 IsNonFilteredLayerVisible="!_showSloopOnly"
                 IsFilteredLayerVisible="!_showSloopOnly">
    <TitleAfterSlot>
        <MudSpacer />
        <MudSwitch @bind-Value="_showSloopOnly"
                   Color="Color.Tertiary"
                   UncheckedColor="Color.Tertiary"
                   Label="Sloops only"
                   Size="Size.Small"
                   Class="mr-2 compact-switch" />
    </TitleAfterSlot>
    <OverlaySlot>
        @if (!string.IsNullOrEmpty(_svgSloops))
        {
            <div class="map-svg-overlay map-svg-overlay-hassloop">
                @((MarkupString)_svgSloops)
            </div>
        }
    </OverlaySlot>
    <LegendSlot>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(0); border: 1px solid #000000;"></span>
            <span>0%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(50); border: 1px solid #000000;"></span>
            <span>50%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(100); border: 1px solid #000000;"></span>
            <span>100%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(150); border: 1px solid #000000;"></span>
            <span>150%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(200); border: 1px solid #000000;"></span>
            <span>200%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(250); border: 1px solid #000000;"></span>
            <span>250%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: transparent; border: 3px solid #7B1FA2;"></span>
            <span>Has Sloop</span>
        </div>
    </LegendSlot>
    <TooltipSlot>
        <div class="tooltip-header">@(_selectedFactory!.Type ?? "Unknown")</div>
        @if (_selectedFactory.Recipe is not null)
        {
            <div class="tooltip-row">
                <span class="tooltip-label">Recipe:</span>
                <span class="tooltip-value">@_selectedFactory.Recipe</span>
            </div>
        }
        <div class="tooltip-row">
            <span class="tooltip-label">ClockSpeed:</span>
            <span class="tooltip-value">@(_selectedFactory.ClockSpeed?.ToString("F1") ?? "-")%</span>
        </div>
        <div class="tooltip-row">
            <span class="tooltip-label">Has Sloop:</span>
            <span class="tooltip-value">@(_selectedFactory.HasSloop ? "Yes" : "No")</span>
        </div>
    </TooltipSlot>
</BaseMap>

@code {
    private static readonly string[] variablePowerTypes = new[]
    {
        "Converter",
        "HadronCollider",
        "QuantumEncoder",
        "TrainStation",
        "ResourceSink",
        "GeneratorGeoThermal"
    };

    private BaseMap? Map;
    private bool _showSloopOnly = false;
    private string? _svgSloops;
    private Factory? _selectedFactory;

    private void SelectedChanged(Factory? factory)
    {
        _selectedFactory = factory;
    }

    private string CreateEdge(string factoryId, Factory factory, string pos)
    {
        var fillColor = GetFactoryColor(factory);
        var shape = GetFactoryShape(factory.Type);
        var borderColor = factory.HasSloop ? "#7B1FA2" : "#000000";
        var penwidth = factory.HasSloop ? 3 : 1;

        return $"\n{factoryId} [shape=\"{shape}\", fillcolor=\"{fillColor}\", color=\"{borderColor}\", penwidth={penwidth}, {pos}];";
    }

    private async Task CustomRender()
    {
        var hasSloop = CustomFactoriesForMapClick();
        _svgSloops = await (Map?.RenderLayerAsync(hasSloop) ?? Task.FromResult((string?)null));
    }

    private List<Factory> CustomFactoriesForMapClick()
    {
        return FactoryStore.NonFilteredFactories
         .Where(f => f.ClockSpeed.HasValue)
         .Where(f => f.HasSloop)
         .ToList();
    }

    private string GetFactoryColor(Factory factory)
    {
        return FactoryColors.GetFactoryColorForClockSpeed(factory.ClockSpeed);
    }

    private string GetLegendColor(float clockSpeed)
    {
        return FactoryColors.GetFactoryColorForClockSpeed(clockSpeed);
    }

    private string GetFactoryShape(string? factoryType)
    {
        return IsVariablePower(factoryType) ? "triangle" : "circle";
    }

    private bool IsVariablePower(string? factoryType)
    {
        return variablePowerTypes.Contains(factoryType);
    }
}

<style>
    .map-svg-overlay-hassloop {
        z-index: 10;
        pointer-events: auto;
    }

    .compact-switch {
        margin: 0;
        padding: 0;
    }

        .compact-switch ::deep .mud-switch-root {
            margin: 0;
            padding: 0;
        }

        .compact-switch ::deep .mud-switch-label {
            margin: 0;
            padding: 0;
            margin-left: 8px;
        }
</style>
