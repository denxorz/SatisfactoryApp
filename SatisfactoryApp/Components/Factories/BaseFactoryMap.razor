@using Denxorz.Satisfactory.Routes.Types
@using Microsoft.JSInterop
@using MudBlazor
@using SatisfactoryApp.Services
@using SatisfactoryApp.Services.Factories
@using SatisfactoryApp.Utils
@inject FactoryStore FactoryStore

<BaseMap Title="Power Circuits"
                 CreateEdge="CreateEdge"
                 SelectedChanged="SelectedChanged"
                 LegendSlot="LegendSlot"
                 ExtraFactoryFilter="ExtraFactoryFilter">
    <TooltipSlot>
        <div class="tooltip-header">@(_selectedFactory!.Type ?? "Unknown")</div>
        @if (_selectedFactory.Recipe is not null)
        {
            <div class="tooltip-row">
                <span class="tooltip-label">Recipe:</span>
                <span class="tooltip-value">@_selectedFactory.Recipe</span>
            </div>
        }
        @if (_selectedFactory.PercentageProducing is not null)
        {
            <div class="tooltip-row">
                <span class="tooltip-label">Running at:</span>
                <span class="tooltip-value">@(_selectedFactory.PercentageProducing.Value.ToString("F1"))%</span>
            </div>
        }
        @if (!string.IsNullOrEmpty(_mainPowerCircuitName))
        {
            <div class="tooltip-row">
                <span class="tooltip-label">Main Circuit:</span>
                <span class="tooltip-value">@_mainPowerCircuitName</span>
            </div>
        }
        @if (!string.IsNullOrEmpty(_subPowerCircuitName))
        {
            <div class="tooltip-row">
                <span class="tooltip-label">Sub Circuit:</span>
                <span class="tooltip-value">@_subPowerCircuitName</span>
            </div>
        }
        <div class="tooltip-row">
            <span class="tooltip-label">Is variable power:</span>
            <span class="tooltip-value">@IsVariablePower(_selectedFactory.Type)</span>
        </div>
    </TooltipSlot>
</BaseMap>

@code {
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public Func<Factory, string> GetFactoryColor { get; set; } = null!;
    [Parameter] public Func<Factory, string>? GetFactoryBorderColor { get; set; }
    [Parameter] public Func<Factory, bool> ExtraFactoryFilter { get; set; } = (f) => true;

    [Parameter] public RenderFragment? LegendSlot { get; set; }

    private static readonly string[] variablePowerTypes = new[]
    {
        "Converter",
        "HadronCollider",
        "QuantumEncoder",
        "TrainStation",
        "ResourceSink",
        "GeneratorGeoThermal"
    };

    private Factory? _selectedFactory;
    private string? _mainPowerCircuitName;
    private string? _subPowerCircuitName;

    private void SelectedChanged(Factory? factory)
    {
        _selectedFactory = factory;
        SetPowerCircuitNames();
    }

    private void SetPowerCircuitNames()
    {
        if (_selectedFactory != null)
        {
            _mainPowerCircuitName = CircuitNames.GetIdAndName(FactoryStore.PowerCircuits.FirstOrDefault(p => p.Id == _selectedFactory.MainPowerCircuitId));
            _subPowerCircuitName = CircuitNames.GetName(FactoryStore.PowerCircuits.FirstOrDefault(p => p.Id == _selectedFactory.SubPowerCircuitId));
        }
        else
        {
            _mainPowerCircuitName = null;
            _subPowerCircuitName = null;
        }
    }

    private string CreateEdge(string factoryId, Factory factory, string pos)
    {
        var color = GetFactoryColor(factory);
        var borderColor = GetFactoryBorderColor?.Invoke(factory) ?? "#000000";
        var shape = GetFactoryShape(factory.Type);

        return $"\n{factoryId} [shape=\"{shape}\", fillcolor=\"{color}\", color=\"{borderColor}\", {pos}];";
    }

    private string GetFactoryShape(string? factoryType)
    {
        return IsVariablePower(factoryType) ? "triangle" : "circle";
    }

    private bool IsVariablePower(string? factoryType)
    {
        return variablePowerTypes.Contains(factoryType);
    }
}
