@using Denxorz.Satisfactory.Routes.Types
@using Microsoft.JSInterop
@using MudBlazor
@using SatisfactoryApp.Services
@using SatisfactoryApp.Services.Factories
@using SatisfactoryApp.Utils
@inject FactoryStore FactoryStore

<BaseMap T="Factory"
         Title="Factory Clock speed"
         SelectedChanged="SelectedChanged"
         Layers="[clockSpeedMapLayer,clockSpeedFilteredMapLayer,sloopMapLayer,sloopFilteredMapLayer]">
    <TitleAfterSlot>
        <MudSpacer />
        <MudSwitch @bind-Value="ShowSloopOnly"
                   Color="Color.Tertiary"
                   UncheckedColor="Color.Tertiary"
                   Label="Sloops only"
                   Size="Size.Small"
                   Class="mr-2 compact-switch" />
    </TitleAfterSlot>
    <LegendSlot>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(0); border: 1px solid #000000;"></span>
            <span>0%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(50); border: 1px solid #000000;"></span>
            <span>50%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(100); border: 1px solid #000000;"></span>
            <span>100%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(150); border: 1px solid #000000;"></span>
            <span>150%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(200); border: 1px solid #000000;"></span>
            <span>200%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: @GetLegendColor(250); border: 1px solid #000000;"></span>
            <span>250%</span>
        </div>
        <div class="legend-item">
            <span class="legend-icon factory" style="background: transparent; border: 3px solid #7B1FA2;"></span>
            <span>Has Sloop</span>
        </div>
    </LegendSlot>
    <TooltipSlot>
        <div class="tooltip-header">@(_selectedFactory!.Type ?? "Unknown")</div>
        @if (_selectedFactory.Recipe is not null)
        {
            <div class="tooltip-row">
                <span class="tooltip-label">Recipe:</span>
                <span class="tooltip-value">@_selectedFactory.Recipe</span>
            </div>
        }
        <div class="tooltip-row">
            <span class="tooltip-label">ClockSpeed:</span>
            <span class="tooltip-value">@(_selectedFactory.ClockSpeed?.ToString("F1") ?? "-")%</span>
        </div>
        <div class="tooltip-row">
            <span class="tooltip-label">Has Sloop:</span>
            <span class="tooltip-value">@(_selectedFactory.HasSloop ? "Yes" : "No")</span>
        </div>
    </TooltipSlot>
</BaseMap>

@code {
    private readonly ClockSpeedFactoryMapLayer clockSpeedMapLayer;
    private readonly ClockSpeedFilteredFactoryMapLayer clockSpeedFilteredMapLayer;
    private readonly SloopsFactoryMapLayer sloopMapLayer;
    private readonly SloopsFilteredFactoryMapLayer sloopFilteredMapLayer;

    private bool _showSloopOnly = false;
    private Factory? _selectedFactory;

    private bool ShowSloopOnly
    {
        get => _showSloopOnly;
        set
        {
            if (_showSloopOnly != value)
            {
                _showSloopOnly = value;
                clockSpeedMapLayer.IsVisible = !_showSloopOnly;
                clockSpeedFilteredMapLayer.IsVisible = !_showSloopOnly;
            }
        }
    }

    public ClockSpeedMap(FactoryStore s)
    {
        clockSpeedMapLayer = new(s);
        clockSpeedFilteredMapLayer = new(s);
        sloopMapLayer = new(s);
        sloopFilteredMapLayer = new(s);
    }

    private void SelectedChanged(Factory? factory)
    {
        _selectedFactory = factory;
    }

    private string GetLegendColor(float clockSpeed)
    {
        return FactoryColors.GetFactoryColorForClockSpeed(clockSpeed);
    }
}

<style>
    .map-svg-overlay-hassloop {
        pointer-events: auto;
    }

    .compact-switch {
        margin: 0;
        padding: 0;
    }

        .compact-switch ::deep .mud-switch-root {
            margin: 0;
            padding: 0;
        }

        .compact-switch ::deep .mud-switch-label {
            margin: 0;
            padding: 0;
            margin-left: 8px;
        }
</style>
