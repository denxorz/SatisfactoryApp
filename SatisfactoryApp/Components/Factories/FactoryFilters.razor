@implements IDisposable
@inject FactoryStore FactoryStore

<MudCard Outlined="true" Square="true" Class="border-solid border-4 mud-border-primary">
    <MudCardHeader Class="mud-primary pa-0 pl-1">
        <MudText Class="primary-card-header-title">Factory Filters</MudText>
    </MudCardHeader>
    <MudCardContent Class="pa-2">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudComboBox 
                    T="FactoryTypeOption"
                    @bind-SelectedValues="@FactoryStore.SelectedFactoryTypes"
                    Variant="Variant.Outlined"
                    MultiSelection
                    Label="Type" 
                    Editable
                    Clearable
                    SelectAll
                    ShowCheckbox>
                    @foreach (var item in FactoryTypeOptions)
                    {
                        <MudComboBoxItem Value="@item" Text="@item.ToString()"></MudComboBoxItem>
                    }
                </MudComboBox>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudComboBox T="PowerCircuitOption"
                             @bind-SelectedValues="@FactoryStore.SelectedPowerCircuits"
                             Variant="Variant.Outlined"
                             MultiSelection
                             Label="Power Circuit"
                             Editable
                             Clearable
                             SelectAll
                             ShowCheckbox>
                    @foreach (var item in PowerCircuitIdOptions)
                    {
                        <MudComboBoxItem Value="@item" Text="@item.ToString()"></MudComboBoxItem>
                    }
                </MudComboBox>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudComboBox T="FactoryStabilityOption"
                             @bind-SelectedValues="@FactoryStore.SelectedFactoryStabilities"
                             Variant="Variant.Outlined"
                             MultiSelection
                             Label="Stability"
                             Editable
                             Clearable
                             SelectAll
                             ShowCheckbox>
                    @foreach (var item in FactoryStabilityOptions)
                    {
                        <MudComboBoxItem Value="@item" Text="@item.ToString()"></MudComboBoxItem>
                    }
                </MudComboBox>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

@code {

    private List<FactoryTypeOption> FactoryTypeOptions = [];
    private List<PowerCircuitOption> PowerCircuitIdOptions = [];
    private List<FactoryStabilityOption> FactoryStabilityOptions = [];

    protected override void OnInitialized() 
    {
        FactoryStore.FactoriesChanged += OnChanged;
        Load();
    }

    private void OnChanged()
    {
        Load();
        StateHasChanged();
    }

    private void Load()
    {
        FactoryTypeOptions = FactoryStore.FactoryTypeOptions;
        PowerCircuitIdOptions = FactoryStore.PowerCircuitIdOptions;
        FactoryStabilityOptions = FactoryStore.FactoryStabilityOptions;
    }

    public void Dispose()
    {
        FactoryStore.FactoriesChanged -= OnChanged;
    }
}
