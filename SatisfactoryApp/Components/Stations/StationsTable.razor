@using Denxorz.Satisfactory.Routes.Types
@using MudBlazor
@using SatisfactoryApp.Services
@using SatisfactoryApp.Services.Stations
@implements IDisposable
@inject StationStore StationStore

<MudCard Outlined="true" Square="true" Class="border-solid border-4 mud-border-primary">
    <MudCardHeader Class="mud-primary pa-0 pl-1">
        <MudText Class="primary-card-header-title" Color="Color.Surface">Stations</MudText>
    </MudCardHeader>
    <MudCardContent Class="pa-2">
        <MudDataGrid Items="@StationStore.FilteredStations" Hover Dense Groupable GroupExpanded>
            <Columns>
                <PropertyColumn Property="x => x.Type" Title="" Groupable="false" CellStyle="width: 200px">
                    <CellTemplate>
                        <MudIcon Icon="@MudBlazor.FontIcons.MaterialSymbols.Outlined.Monorail" Size="Size.Small" Color="Color.Info" Class=@($"ml-4 {(context.Item.Type != "train" ? "disabled-faded-icon" : "")}") />
                        <MudIcon Icon="@MudBlazor.FontIcons.MaterialSymbols.Outlined.LocalShipping" Size="Size.Small" Color="Color.Info" Class=@($"{(context.Item.Type != "truck" ? "disabled-faded-icon" : "")}") />
                        <MudIcon Icon="@MudBlazor.FontIcons.MaterialSymbols.Outlined.Flight" Size="Size.Small" Color="Color.Info" Class=@($"{(context.Item.Type != "drone" ? "disabled-faded-icon" : "")}") />
                        <MudIcon Icon="@MudBlazor.FontIcons.MaterialSymbols.Outlined.Input" Size="Size.Small" Color="Color.Tertiary"  Class=@($"{(context.Item.IsUnload ? "disabled-faded-icon" : "")}") />
                        <MudIcon Icon="@MudBlazor.FontIcons.MaterialSymbols.Outlined.Output" Size="Size.Small" Color="Color.Primary" Class=@($"{(!context.Item.IsUnload ? "disabled-faded-icon" : "")}") />
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.ShortName" Title="Station" Grouping Hidden />
                <PropertyColumn Property="x => x.CargoFlows" Title="Cargo" Groupable="false">
                    <CellTemplate>
                        <MudText>@GetCargoFlowText(context.Item)</MudText>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="@(x => x.Transporters != null ? x.Transporters.Count : 0)" Title="Vehicles" align="right" Groupable="false">
                    <CellTemplate>
                        <MudText>@(context.Item.Transporters?.Count ?? 0)</MudText>
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="" Sortable="false" Groupable="false">
                    <CellTemplate>
                        <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="@(() => ShowStationDetails(context.Item))">
                            Details
                        </MudButton>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <GroupTemplate>
                <span style="font-weight:bold">
                    @if (context.DataGrid.FilteredItems.Any())
                    {
                        var station = context.Grouping.First();

                        var hasTrains = context.Grouping.Any(s => s.Type == "train");
                        var hasTrucks = context.Grouping.Any(s => s.Type == "truck");
                        var hasDrones = context.Grouping.Any(s => s.Type == "drone");
                        var hasLoad = context.Grouping.Any(s => !s.IsUnload);
                        var hasUnload = context.Grouping.Any(s => s.IsUnload);

                        <div class="d-flex align-center">
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Monorail)" Disabled="!hasTrains" Size="Size.Small" Color="Color.Info" Class=@($"mr-1 {(!hasTrains ? "disabled-faded-icon" : "")}") />
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.LocalShipping)" Disabled="!hasTrucks" Size="Size.Small" Color="Color.Info" Class=@($"mr-1 {(!hasTrucks ? "disabled-faded-icon" : "")}") />
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Flight)" Disabled="!hasDrones" Size="Size.Small" Color="Color.Info" Class=@($"mr-1 {(!hasDrones ? "disabled-faded-icon" : "")}") />
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Input)" Disabled="!hasLoad" Size="Size.Small" Color="Color.Tertiary" Class=@($"mr-1 {(!hasLoad ? "disabled-faded-icon" : "")}") />
                            <MudIcon Icon="@(MudBlazor.FontIcons.MaterialSymbols.Outlined.Output)" Disabled="!hasUnload" Size="Size.Small" Color="Color.Primary" Class=@($"mr-1 {(!hasUnload ? "disabled-faded-icon" : "")}") />
                            <span class="ml-4">@station.ShortName</span>
                        </div>
                    }
                    else
                    {
                        <span style="font-weight:bold">??</span>
                    }
                </span>
            </GroupTemplate>
        </MudDataGrid>

        <MudDialog @bind-Visible="_showStationDetailsDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
            <TitleContent>
                <MudText Typo="Typo.h6">Station Details</MudText>
            </TitleContent>
            <DialogContent>
                @if (_selectedStation != null)
                {
                    <MudGrid Spacing="1">
                        <MudItem xs="4"><MudText><strong>Id:</strong></MudText></MudItem>
                        <MudItem xs="8"><MudText>@(_selectedStation.Id ?? "??")</MudText></MudItem>
                        <MudItem xs="4"><MudText><strong>Name:</strong></MudText></MudItem>
                        <MudItem xs="8"><MudText>@(_selectedStation.Name ?? "??")</MudText></MudItem>
                        <MudItem xs="4"><MudText><strong>Type:</strong></MudText></MudItem>
                        <MudItem xs="8"><MudText>@(_selectedStation.IsUnload ? "Unload" : "Load")</MudText></MudItem>
                        <MudItem xs="4"><MudText><strong>Cargo Type:</strong></MudText></MudItem>
                        <MudItem xs="8"><MudText>@(string.Join("/", _selectedStation.CargoTypes ?? new List<string>()) ?? "Unknown")</MudText></MudItem>
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText><strong>Vehicles:</strong></MudText>
                            @if (_selectedStation.Transporters != null && _selectedStation.Transporters.Count > 0)
                            {
                                <ul>
                                    @foreach (var vehicle in _selectedStation.Transporters)
                                    {
                                        <li>
                                            @(vehicle.Name ?? vehicle.Id)
                                            (Destinations: @string.Join(", ", GetDestinations(vehicle, _selectedStation.Id)))
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <MudText Class="text-muted">No vehicles associated with this station</MudText>
                            }
                        </MudItem>
                    </MudGrid>
                }
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="@(() => _showStationDetailsDialog = false)">Close</MudButton>
            </DialogActions>
        </MudDialog>
    </MudCardContent>
</MudCard>

<style>
    .disabled-faded-icon {
        color: var(--mud-palette-background-grey, #2b2b2b) !important;
        fill: var(--mud-palette-background-grey, #2b2b2b) !important;
        opacity: 0.90 !important;
    }
</style>

@code {

    private bool _showStationDetailsDialog = false;
    private Station? _selectedStation;

    protected override void OnInitialized()
    {
        StationStore.FilteredStationsChanged += StateHasChanged;
    }

    private void ShowStationDetails(Station station)
    {
        _selectedStation = station;
        _showStationDetailsDialog = true;
    }

    private string GetCargoFlowText(Station station)
    {
        if (station.CargoFlows == null || station.CargoFlows.Count == 0)
        {
            return "Unknown";
        }

        var parts = new List<string>();
        foreach (var cf in station.CargoFlows)
        {
            var prefix = (cf.IsExact ? "" : "~") + (station.IsUnload ? "-" : "+");
            var flow = cf.FlowPerMinute.HasValue ? cf.FlowPerMinute.Value.ToString("F0") : "??";
            parts.Add($"{prefix}{flow} {cf.Type}");
        }
        return string.Join(" / ", parts);
    }

    private List<string> GetDestinations(Transporter transporter, string currentStationId)
    {
        var destinationIds = new List<string>();
        if (!string.IsNullOrEmpty(transporter.From)) destinationIds.Add(transporter.From);
        if (!string.IsNullOrEmpty(transporter.To)) destinationIds.Add(transporter.To);
        if (transporter.OtherStops != null) destinationIds.AddRange(transporter.OtherStops);

        var destinationStations = StationStore.Stations
            .Where(s => destinationIds.Contains(s.Id) && s.Id != currentStationId)
            .Select(s => s.Name ?? "Unnamed Station")
            .ToList();

        return destinationStations;
    }

    public void Dispose()
    {
        StationStore.FilteredStationsChanged -= StateHasChanged;
    }
}

