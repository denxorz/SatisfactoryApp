@using SatisfactoryApp.Services
@using Denxorz.Satisfactory.Routes.Types
@using SatisfactoryApp.Utils
@using MudBlazor
@inject FactoryStore FactoryStore
@implements IDisposable

<MudCard Outlined="true" Square="true" Class="border-solid border-4 mud-border-primary">
    <MudCardHeader Class="mud-primary pa-0 pl-1">
        <MudText Class="primary-card-header-title" Color="Color.Surface">Power Circuits</MudText>
    </MudCardHeader>
    <MudCardContent Class="pa-2">
        <MudTable Items="@_powerCircuitStats" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh align="right">Total</MudTh>
                <MudTh align="right">Not running at 100%</MudTh>
                <MudTh align="right">Variable power</MudTh>
                <MudTh align="right">Priority</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudText Color="@(context.IsStable ? Color.Success : Color.Primary)">@context.CircuitName</MudText>
                </MudTd>
                <MudTd DataLabel="Total" align="right">@context.Total</MudTd>
                <MudTd DataLabel="Stable" align="right">
                    <MudText Color="@(context.NotStable != 0 ? Color.Primary : Color.Default)">(@context.NotStable / @context.Total)</MudText>
                </MudTd>
                <MudTd DataLabel="Variable power" align="right">
                    <MudText Color="@(context.VariablePower > 0 ? Color.Primary : Color.Default)">( @context.VariablePower  / @context.Total)</MudText>
                </MudTd>
                <MudTd DataLabel="Priority" align="right">@context.Priority</MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private List<PowerCircuitStat> _powerCircuitStats = [];

    protected override void OnInitialized()
    {
        FactoryStore.FactoriesChanged += UpdateStats;
        UpdateStats();
    }

    public void Dispose()
    {
        FactoryStore.FactoriesChanged -= UpdateStats;
    }

    private void UpdateStats()
    {
        var stats = new Dictionary<int, PowerCircuitStat>();

        foreach (var c in FactoryStore.PowerCircuits)
        {
            bool isMainCircuit = c.ParentCircuitId is null;
            var factories = FactoryStore.Factories
                .Where(f => isMainCircuit ? f.MainPowerCircuitId == c.Id : f.SubPowerCircuitId == c.Id)
                .ToList();

            var notStable = factories.Count(f => f.PercentageProducing is not null && f.PercentageProducing != 100);
            var variablePower = factories.Count(IsSpecialFactory);

            stats[c.Id] = new PowerCircuitStat
                {
                    CircuitId = c.Id,
                    CircuitName = CircuitNames.GetName(c),
                    Total = factories.Count,
                    NotStable = notStable,
                    VariablePower = variablePower,
                    Priority = c.Priority,
                    IsStable = notStable == 0 && variablePower== 0
                };
        }

        _powerCircuitStats = stats.Values
            .OrderBy(s => s.CircuitId)
            .ToList();

        StateHasChanged();
    }

    private static bool IsSpecialFactory(Factory factory)
    {
        var specialTypes = new[] { "Converter", "HadronCollider", "QuantumEncoder", "TrainStation", "ResourceSink", "GeneratorGeoThermal" };
        return factory.Type != null && specialTypes.Contains(factory.Type);
    }

    private class PowerCircuitStat
    {
        public int CircuitId { get; set; }
        public string CircuitName { get; set; } = string.Empty;
        public int Total { get; set; }
        public int NotStable { get; set; }
        public int VariablePower { get; set; }
        public int? Priority { get; set; }
        public bool IsStable { get; set; }
    }
}

